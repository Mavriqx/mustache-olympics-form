<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Enter the 2025 Mustache Games</title>

  <!-- Self-hosted Uppy CSS -->
  <link rel="stylesheet" href="/uppy.min.css"/>

  <style>
    :root{
      --border:#e0e0e0;
      --border-strong:#ccc;
      --bg:#fff;
      --promo-bg:#f4f4f4;
      --brand:#7B1E25;   /* Burgundy */
      --brand-dark:#61181E;
      --text:#333;
      --muted:#555;
      --radius:8px;
    }

    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      line-height:1.6;
      color:var(--text);
      max-width:640px;
      margin:40px auto;
      padding:0 20px
    }
    .title-container{
      display:flex;
      flex-direction:column;
      gap:15px;
      margin-bottom:8px
    }
    .logo-container{
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:20px;
      background:var(--bg)
    }
    .logo{
      max-width:300px;
      margin:0 auto;
      display:block
    }
    h1{
      color:#111;
      margin:0;
      line-height:1.2;
      text-align:left
    }

    /* Make promo + email banner look like inputs (same width/border/radius) */
    .banner-like,
    input, select {
      width:100%;
      box-sizing:border-box;
      border:1px solid var(--border-strong);
      border-radius:6px;
    }
    .social-promo{
      background:var(--promo-bg);
      padding:10px 12px;
      margin:16px 0 20px 0;
      border-left:4px solid var(--brand);
    }
    #email-display{
      background:#f8f9fa;
      padding:10px 12px;
      margin:10px 0 12px 0;
    }

    form{
      display:flex;
      flex-direction:column;
      gap:20px
    }
    label{
      font-weight:600
    }
    input,select{
      padding:10px;
      font-size:16px
    }

    /* Consent: structured card aligned with fields */
    .consent-card{
      display:grid;
      grid-template-columns:auto 1fr;
      gap:12px;
      align-items:start;
      border:1px solid var(--border-strong);
      border-radius:6px;
      background:var(--bg);
      padding:12px;
      margin-top:12px;
    }
    .consent-card input[type="checkbox"]{margin-top:4px}
    .consent-card label{
      font-weight:400;
      color:var(--muted)
    }

    /* Uploader */
    .upload-wrapper{margin-top:6px}
    .upload-container{
      border:1px solid var(--border-strong);
      border-radius:6px;
      padding:15px;
      background:#fff
    }
    /* Hide duplicate progress line & remove inner scrollbar */
    #upload-status{display:none!important;}
    .uppy-Dashboard-files{max-height:none!important;}

    /* Status message */
    #status{
      margin-top:20px;
      padding:12px;
      border-radius:6px;
      text-align:center;
      display:none
    }
    .success{background:#d4edda;color:#155724}
    .error{background:#f8d7da;color:#721c24}

    /* Section headers */
    .main-legend {
      font-size: 1.2em;
      font-weight: 700;
      color: var(--brand);
      margin-bottom: 6px;
      display: block;
      border-bottom: 2px solid var(--brand);
      padding-bottom: 4px;
    }
    .section-subtitle {
      font-size: 0.9em;
      color: var(--muted);
      margin: 4px 0 12px;
      font-style: italic;
    }
    
    /* Accordions */
    .accordion {
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 10px;
      background: #fff;
    }
    .accordion summary {
      font-weight: 700;
      padding: 14px;
      cursor: pointer;
    }
    .accordion-content {
      padding: 0 14px 14px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    /* Submit area: right-aligned burgundy button */
    .actions{
      display:flex;
      justify-content:flex-end;
      margin-top:4px
    }
    .btn-primary{
      background:var(--brand);
      color:#fff;
      border:none;
      border-radius:6px;
      padding:12px 20px;
      font-size:16px;
      cursor:pointer;
    }
    .btn-primary:hover{background:var(--brand-dark)}
    .btn-primary:disabled{background:#bbb; cursor:not-allowed}
    .uppy-StatusBar-actionBtn--done,
    .uppy-DashboardContent-bar .uppy-DashboardContent-save{
      display:none!important;
    }
  </style>
</head>
<body>
  <div class="title-container">
    <div class="logo-container">
      <img src="Black.png" alt="Mustache Games Logo" class="logo">
    </div>
    <h1>Enter the 2025 Mustache Games</h1>
  </div>

  <div class="social-promo banner-like">
    Upload your video below. Let the games & grooming begin!
  </div>

  <form id="contest-form">
    <div class="form-section-container">
      <legend class="main-legend">Required Information</legend>

      <div id="email-display" class="banner-like" style="display:none;"></div>
      <input type="hidden" id="email" name="email">

      <div>
        <label for="firstName">First Name</label>
        <input type="text" id="firstName" name="firstName" required>
      </div>
      <div>
        <label for="lastName">Last Name</label>
        <input type="text" id="lastName" name="lastName" required>
      </div>
      <div>
        <label for="city">City</label>
        <input type="text" id="city" name="city" required>
      </div>

      <div>
        <label for="state">U.S. State or International</label>
        <select id="state" name="state" required>
          <option value="" disabled selected hidden>Select your state or other…</option>
          <option value="AL">Alabama</option>
          <option value="AL">Alabama</option>
          <option value="AK">Alaska</option>
          <option value="AS">American Samoa</option>
          <option value="AZ">Arizona</option>
          <option value="AR">Arkansas</option>
          <option value="CA">California</option>
          <option value="CO">Colorado</option>
          <option value="CT">Connecticut</option>
          <option value="DE">Delaware</option>
          <option value="DC">District of Columbia</option>
          <option value="FL">Florida</option>
          <option value="GA">Georgia</option>
          <option value="GU">Guam</option>
          <option value="HI">Hawaii</option>
          <option value="ID">Idaho</option>
          <option value="IL">Illinois</option>
          <option value="IN">Indiana</option>
          <option value="IA">Iowa</option>
          <option value="KS">Kansas</option>
          <option value="KY">Kentucky</option>
          <option value="LA">Louisiana</option>
          <option value="ME">Maine</option>
          <option value="MD">Maryland</option>
          <option value="MA">Massachusetts</option>
          <option value="MI">Michigan</option>
          <option value="MN">Minnesota</option>
          <option value="MS">Mississippi</option>
          <option value="MO">Missouri</option>
          <option value="MT">Montana</option>
          <option value="NE">Nebraska</option>
          <option value="NV">Nevada</option>
          <option value="NH">New Hampshire</option>
          <option value="NJ">New Jersey</option>
          <option value="NM">New Mexico</option>
          <option value="NY">New York</option>
          <option value="NC">North Carolina</option>
          <option value="ND">North Dakota</option>
          <option value="MP">Northern Mariana Islands</option>
          <option value="OH">Ohio</option>
          <option value="OK">Oklahoma</option>
          <option value="OR">Oregon</option>
          <option value="PA">Pennsylvania</option>
          <option value="PR">Puerto Rico</option>
          <option value="RI">Rhode Island</option>
          <option value="SC">South Carolina</option>
          <option value="SD">South Dakota</option>
          <option value="TN">Tennessee</option>
          <option value="TX">Texas</option>
          <option value="UT">Utah</option>
          <option value="VT">Vermont</option>
          <option value="VA">Virginia</option>
          <option value="VI">U.S. Virgin Islands</option>
          <option value="WA">Washington</option>
          <option value="WV">West Virginia</option>
          <option value="WI">Wisconsin</option>
          <option value="WY">Wyoming</option>
          <option value="IT">Other</option>
        </select>
      </div>

      <!-- NEW FIELD: Are you the person in the video? -->
      <div>
        <label for="isSubmitterInVideo">Are you the person in the video?</label>
        <select id="isSubmitterInVideo" required>
          <option value="" disabled selected hidden>Select one…</option>
          <option value="yes">Yes – I’m in the video</option>
          <option value="no">No – it features someone else</option>
        </select>
      </div>

      <!-- Structured consent card -->
      <div class="consent-card">
        <input type="checkbox" id="consents" required>
        <label for="consents">
          I’m at least 18 and agree to receive event updates and to the
          <a href="https://maxstache.com/pages/terms-conditions-privacy" target="_blank" rel="noopener">
            Terms, Conditions &amp; Privacy Policy
          </a>.
        </label>
      </div>

      <div class="upload-wrapper">
        <label class="upload-text">Upload Your Video</label>
        <div class="upload-container">
          <div id="uppy"></div>
        </div>
        <p style="font-size:0.9em;color:#666;margin-top:6px;">
          Please upload a <strong>MP4</strong> or <strong>MOV</strong> video up to <strong>30 seconds</strong> (max <strong>1 GB</strong>).
        </p>
        <div id="upload-status"></div>
      </div>
    </div>

    <div class="form-section-container">
      <legend class="main-legend">Optional Information</legend>
      <p class="section-subtitle">
        It only takes 30 seconds — complete the optional questions below to shape next year’s Mustache Games.
      </p>

      <details class="accordion">
        <summary>About Your Talent</summary>
        <div class="accordion-content">
          <div>
            <label for="talentDescription">How would you describe you talent?</label>
            <select id="talentDescription">
              <option value="">select option</option>
              <option>Athletic</option>
              <option>Funny</option>
              <option>Artistic</option>
              <option>Outrageous</option>
            </select>
          </div>
          <div>
            <label for="talentOrigin">How did you pick your talent?</label>
            <select id="talentOrigin">
              <option value="">select option</option>
              <option>Years of Practice</option>
              <option>Happy Accident</option>
              <option>On a Dare</option>
              <option>Natural Calling</option>
              <option>Just Felt Right</option>
            </select>
          </div>
        </div>
      </details>

      <details class="accordion">
        <summary>About Your 'Stache</summary>
        <div class="accordion-content">
          <div>
            <label for="stacheFrequency">How often do you rock a 'stache?</label>
            <select id="stacheFrequency">
              <option value="">select option</option>
              <option>All the time</option>
              <option>Sometimes</option>
              <option>Special Occasions</option>
              <option>Barely</option>
              <option>Just for this event</option>
            </select>
          </div>
          <div>
            <label for="fullness">How would you describe your 'stache type?</label>
            <select id="fullness">
              <option value="">select option</option>
              <option>Thick or Bushy</option>
              <option>About Average</option>
              <option>Skinny or Thin</option>
            </select>
          </div>
          <div>
            <label for="generalStyle">How would you describe your 'stache style?</label>
            <select id="generalStyle">
              <option value="">select option</option>
              <option>Perfectly Sculpted</option>
              <option>Waxed or Styled</option>
              <option>Mostly Natural</option>
              <option>Wild or Untamed</option>
            </select>
          </div>
        </div>
      </details>

      <details class="accordion">
        <summary>About You</summary>
        <div class="accordion-content">
          <div>
            <label for="source">How did you learn about this event?</label>
            <select id="source">
              <option value="">select option</option>
              <option>Friend or Family</option>
              <option>Social Media</option>
              <option>Event Card</option>
              <option>Other</option>
            </select>
          </div>
          <div>
            <label for="socialPlatform">What's your favorite social media platform?</label>
            <select id="socialPlatform">
              <option value="">select option</option>
              <option>TikTok</option>
              <option>Instagram</option>
              <option>Facebook</option>
              <option>YouTube</option>
              <option>Other</option>
            </select>
          </div>
          <div>
            <label for="socialHandle">What's your social media handle?</label>
            <input type="text" id="socialHandle" placeholder="@yourhandle">
          </div>
          <div>
            <label for="phone">What's your phone mumber 
              <span class="optional-label">(for event updates via text)?</span>
            </label>
            <input type="tel" id="phone">
          </div>
        </div>
      </details>
    </div>

    <div class="actions">
      <button type="submit" id="submit-button" class="btn-primary" disabled>Submit My Entry</button>
    </div>
  </form>

  <div id="status"></div>

  <!-- Uppy JS -->
  <script src="/uppy.min.js"></script>
  <script>
    const SIGNER_BASE="https://2gflx5uo7lqzj2exr2dgybofrq0uvrhy.lambda-url.us-east-2.on.aws";
    const BUCKET="maxstache-uploads-2025-mustache-olympics";
    const REGION="us-east-2";
    const LAMBDA_ENDPOINT="https://lf5ekhxuvwgwuhc34tsis6eldm0ltwzr.lambda-url.us-east-2.on.aws/";

    const statusDiv=document.getElementById('status');
    const submitButton=document.getElementById('submit-button');
    const uploadStatus=document.getElementById('upload-status');
    let lastSubmissionId=null,lastS3Key=null;

    function showStatus(msg,type){
      statusDiv.className=type;
      statusDiv.textContent=msg;
      statusDiv.style.display='block';
    }
    function toPid(email){
      return email?('PID-'+email.toLowerCase().replace(/[^a-z0-9]+/g,'-').slice(0,32)):'PID-UNKNOWN';
    }

    (function initEmail(){
      const eD=document.getElementById('email-display');
      const eH=document.getElementById('email');
      const params=new URLSearchParams(window.location.search);
      const urlEmail=params.get('email');
      if(urlEmail)localStorage.setItem('mo_email',urlEmail);
      const email=urlEmail||localStorage.getItem('mo_email')||'';
      if(email){
        eH.value=email;
        eD.innerHTML=`Submitting for: <strong>${email}</strong>`;
        eD.style.display='block';
      }
    })();

    document.addEventListener('DOMContentLoaded',()=>{
      const U=window.Uppy;
      if(!U){
        showStatus('Upload component failed to load.','error');
        return;
      }

      const uppy=new U.Uppy({
        autoProceed:true,
        restrictions:{
          maxNumberOfFiles:1,
          allowedFileTypes:['video/mp4','video/quicktime'],
          maxFileSize:1024*1024*1024
        }
      });

      uppy.use(U.Dashboard,{
        inline:true,
        target:'#uppy',
        height:220,
        note:'Upload a MP4 or MOV video (max 1 GB).',
        proudlyDisplayPoweredByUppy:false,
        showProgressDetails:true,
        hideUploadButton:true,
        hideRetryButton:true,
        hidePauseResumeButton:true,
        showRemoveButtonAfterComplete:true
      });

      uppy.use(U.AwsS3Multipart,{
        limit:4,
        createMultipartUpload:async(file)=>{
          const email=document.getElementById('email').value.trim();
          const participantId=toPid(email);
          const r=await fetch(`${SIGNER_BASE}/create-mpu`,{
            method:'POST',
            headers:{'content-type':'application/json'},
            body:JSON.stringify({
              participantId,
              filename:file.name||'video.mp4',
              mimeType:file.type||'video/mp4'
            })
          });
          if(!r.ok)throw new Error('Could not start upload');
          const {uploadId,key,submissionId}=await r.json();
          uppy.setFileMeta(file.id,{submissionId,s3Key:key});
          lastSubmissionId=submissionId;
          lastS3Key=key;
          uploadStatus.textContent='Uploading…';
          return {uploadId,key};
        },
        signPart:async(file,{key,uploadId,partNumber})=>{
          const r=await fetch(`${SIGNER_BASE}/sign-part`,{
            method:'POST',
            headers:{'content-type':'application/json'},
            body:JSON.stringify({key,uploadId,partNumber})
          });
          if(!r.ok)throw new Error('Could not sign part');
          const {url}=await r.json();
          return {url};
        },
        completeMultipartUpload:async(file,{key,uploadId,parts})=>{
          const r=await fetch(`${SIGNER_BASE}/complete-mpu`,{
            method:'POST',
            headers:{'content-type':'application/json'},
            body:JSON.stringify({key,uploadId,parts})
          });
          if(!r.ok)throw new Error('Could not complete upload');
          await r.json();
          return {
            location:`https://${BUCKET}.s3.${REGION}.amazonaws.com/${encodeURIComponent(key)}`
          };
        }
      });

      uppy.on('upload-progress',(file,progress)=>{
        const pct=Math.round((progress.bytesUploaded/progress.bytesTotal)*100);
        uploadStatus.textContent=`Uploading… ${pct}%`;
      });

      uppy.on('complete',()=>{
        uploadStatus.textContent='Upload complete ✅';
        submitButton.disabled=false;
      });

      uppy.on('error',(err)=>{
        showStatus('Upload error: '+(err.message||err),'error');
        submitButton.disabled=true;
      });
    });

    document.getElementById('contest-form').addEventListener('submit',async(e)=>{
      e.preventDefault();
      submitButton.disabled=true;
      submitButton.textContent='Submitting…';

      const email=document.getElementById('email').value;
      if(!email){
        showStatus('Email is missing.','error');
        submitButton.disabled=false;
        submitButton.textContent='Submit My Entry';
        return;
      }
      if(!lastSubmissionId){
        showStatus('Upload your video first.','error');
        submitButton.disabled=false;
        submitButton.textContent='Submit My Entry';
        return;
      }
      if(!document.getElementById('consents').checked){
        showStatus('Please check the consent box.','error');
        submitButton.disabled=false;
        submitButton.textContent='Submit My Entry';
        return;
      }

      const payload={
        firstName:document.getElementById('firstName').value,
        lastName:document.getElementById('lastName').value,
        email,
        city:document.getElementById('city').value,
        state:document.getElementById('state').value,
        phone:document.getElementById('phone')?.value||'',
        socialPlatform:document.getElementById('socialPlatform')?.value||'',
        socialHandle:document.getElementById('socialHandle')?.value||'',
        eventSource:document.getElementById('source')?.value||'',
        stacheDescription:document.getElementById('fullness')?.value||'',
        stacheStyle:document.getElementById('generalStyle')?.value||'',
        stacheFrequency:document.getElementById('stacheFrequency')?.value||'',
        talentDescription:document.getElementById('talentDescription')?.value||'',
        talentOrigin:document.getElementById('talentOrigin')?.value||'',
        // NEW FIELD
        isSubmitterInVideo: document.getElementById('isSubmitterInVideo')?.value || '',
        submissionId:lastSubmissionId,
        fileUUID:lastSubmissionId,
        s3Key:lastS3Key,
        marketingConsent:document.getElementById('consents').checked
      };

      try{
        const resp=await fetch(LAMBDA_ENDPOINT,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(payload)
        });
        if(resp.ok){
          showStatus('Success! Redirecting…','success');
          setTimeout(()=>{
            window.location.href='https://maxstache.com/pages/thanks-for-your-submission';
          },2500);
        }else{
          const err=await resp.json().catch(()=>({}));
          showStatus('Error: '+(err.message||'Could not submit.'),'error');
          submitButton.disabled=false;
          submitButton.textContent='Submit My Entry';
        }
      }catch(e){
        showStatus('Network error.','error');
        submitButton.disabled=false;
        submitButton.textContent='Submit My Entry';
      }
    });
  </script>
</body>
</html>
